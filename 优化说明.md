# 代码优化说明 - 自定义过滤器功能修复

## 🐛 问题描述

### 问题 1：自定义过滤器配置未保存
**现象**：在 GUI 中设置的自定义过滤器（`custom_filter`）没有被保存到 `config.json` 文件中

**原因**：`saveConfiguration()` 函数只保存了 `path`、`enabled` 和 `presets` 字段，遗漏了 `filter` 字段

### 问题 2：配置参数设置不清楚
**现象**：用户不知道如何在自定义模式下正确设置 config 参数

**原因**：缺少详细的配置文档和使用说明

---

## ✅ 解决方案

### 1. 修复 `saveConfiguration()` 函数

**文件**：`src/gui_app.cpp`

**修改内容**：
- 添加了 `custom_filter` 的保存逻辑
- 保存 `filter.mode`（whitelist/blacklist）
- 保存 `filter.extensions` 扩展名列表
- 完善了 `strategy` 的所有参数保存

**修改后的代码**：
```cpp
// 保存自定义过滤器配置
if (source.custom_filter && source.custom_filter->mode != FilterConfig::Mode::None) {
    nlohmann::json filter_json;
    
    // 保存模式
    if (source.custom_filter->mode == FilterConfig::Mode::Whitelist) {
        filter_json["mode"] = "whitelist";
    } else if (source.custom_filter->mode == FilterConfig::Mode::Blacklist) {
        filter_json["mode"] = "blacklist";
    }
    
    // 保存扩展名列表
    if (!source.custom_filter->extensions.empty()) {
        filter_json["extensions"] = source.custom_filter->extensions;
    }
    
    source_json["filter"] = filter_json;
}
```

### 2. 改进 GUI 界面提示

**文件**：`src/gui_app.cpp`

**修改内容**：
- 添加了"会覆盖预设"的提示
- 添加了扩展名输入格式说明
- 添加了底部使用提示区域

**新增的提示文本**：
```
💡 提示：
• 预设：快速应用预定义的过滤规则
• 自定义过滤器：精确控制要备份的文件类型
• 白名单：只备份列表中的文件类型
• 黑名单：排除列表中的文件类型，备份其他所有文件
• 如果同时设置预设和自定义过滤器，自定义过滤器优先
```

### 3. 创建详细的配置文档

#### 新增文档列表：

1. **自定义过滤器配置说明.md**
   - 详细的使用场景说明
   - GUI 操作步骤
   - 配置参数详解
   - 完整配置示例
   - 常见问题解答

2. **快速配置参考.md**
   - 5分钟快速上手指南
   - 配置文件结构速查
   - 常用配置模板
   - 预设列表速查
   - 问题排查清单

3. **config_自定义过滤器示例.json**
   - 14个实际使用示例
   - 涵盖各种常见场景
   - 包含详细注释

4. **更新 README.md**
   - 添加自定义过滤器说明
   - 添加更多配置示例
   - 完善常见问题

---

## 📋 配置方式对比

### 方式 1：使用预设（推荐）
```json
{
  "path": "D:\\Projects",
  "enabled": true,
  "presets": ["code", "common_blacklist"]
}
```
**优点**：简单、快速、易维护  
**适用**：常见场景（代码、文档、图片等）

### 方式 2：自定义白名单
```json
{
  "path": "D:\\Projects",
  "enabled": true,
  "filter": {
    "mode": "whitelist",
    "extensions": [".py", ".js", ".cpp"]
  }
}
```
**优点**：精确控制、只备份指定类型  
**适用**：特定文件类型备份

### 方式 3：自定义黑名单
```json
{
  "path": "D:\\Documents",
  "enabled": true,
  "filter": {
    "mode": "blacklist",
    "extensions": [".tmp", ".log", ".cache"]
  }
}
```
**优点**：灵活排除、备份大部分文件  
**适用**：排除特定类型

---

## 🎯 使用指南

### GUI 操作流程

1. **打开设置**
   - 右键托盘图标 → "备份设置"

2. **添加/编辑备份源**
   - 点击"添加"或选中后点击"配置"

3. **选择过滤方式**
   - **简单方式**：双击左侧预设列表
   - **自定义方式**：在右侧配置过滤器

4. **配置自定义过滤器**
   - 选择模式（白名单/黑名单/无）
   - 输入扩展名（如 `txt` 或 `.txt`）
   - 点击"添加"按钮
   - 重复添加多个扩展名

5. **保存配置**
   - 点击"确定"保存源配置
   - 点击"保存"应用到 config.json

6. **重启监控**
   - 右键托盘图标 → "停止监控"
   - 右键托盘图标 → "启动监控"

### 配置文件编辑流程

1. **打开配置文件**
   - 右键托盘图标 → "编辑配置文件"
   - 或直接编辑 `config.json`

2. **添加 filter 字段**
   ```json
   {
     "path": "D:\\Projects",
     "enabled": true,
     "filter": {
       "mode": "whitelist",
       "extensions": [".py", ".js"]
     }
   }
   ```

3. **保存并重启**
   - 保存文件
   - 重启监控服务

---

## 📊 配置优先级

```
filter (自定义过滤器)
    ↓ 优先于
presets (预设)
    ↓ 优先于
无配置 (备份所有文件)
```

**规则**：
- 如果设置了 `filter`，使用 `filter`，忽略 `presets`
- 如果只设置了 `presets`，使用 `presets`
- 如果都没设置，备份所有文件

---

## 🔍 验证方法

### 1. 检查配置文件
打开 `config.json`，确认 `filter` 字段已保存：
```json
{
  "backup_sources": [
    {
      "path": "D:\\Projects",
      "enabled": true,
      "filter": {
        "mode": "whitelist",
        "extensions": [".py", ".js"]
      }
    }
  ]
}
```

### 2. 查看备份格式窗口
- 右键托盘图标 → "备份格式"
- 滚动到底部查看"当前监控路径配置"
- 确认显示了正确的过滤器设置

### 3. 测试备份
1. 创建测试文件（如 `test.py` 和 `test.txt`）
2. 修改文件内容
3. 检查备份目录是否只备份了白名单中的文件
4. 查看日志文件确认过滤规则生效

---

## 📝 配置示例

### 示例 1：前端项目
```json
{
  "path": "D:\\Projects\\WebApp",
  "enabled": true,
  "filter": {
    "mode": "whitelist",
    "extensions": [
      ".js", ".ts", ".jsx", ".tsx",
      ".vue", ".html", ".css", ".scss",
      ".json", ".yaml"
    ]
  }
}
```

### 示例 2：Python项目
```json
{
  "path": "D:\\Projects\\PythonApp",
  "enabled": true,
  "filter": {
    "mode": "whitelist",
    "extensions": [
      ".py", ".pyx", ".pyi",
      ".txt", ".md", ".rst",
      ".json", ".yaml", ".toml"
    ]
  }
}
```

### 示例 3：排除大文件
```json
{
  "path": "D:\\Documents",
  "enabled": true,
  "filter": {
    "mode": "blacklist",
    "extensions": [
      ".mp4", ".avi", ".mkv",
      ".zip", ".rar", ".7z",
      ".iso", ".dmg"
    ]
  }
}
```

---

## ⚠️ 注意事项

1. **配置生效**
   - 修改配置后必须重启监控服务
   - GUI：停止监控 → 启动监控

2. **扩展名格式**
   - 可以写 `.txt` 或 `txt`
   - 程序会自动处理
   - 建议统一使用 `.txt` 格式

3. **优先级**
   - `filter` 会覆盖 `presets`
   - 如果想用预设，不要设置 `filter`

4. **性能考虑**
   - 白名单模式性能最好
   - 扩展名列表不要太长（< 50个）

5. **备份验证**
   - 配置后先测试小目录
   - 查看日志确认规则生效
   - 确认无误后再应用到重要数据

---

## 🐛 问题排查

### 问题：配置保存后不生效

**检查清单**：
- [ ] 确认已点击"保存"按钮
- [ ] 确认 config.json 文件已更新
- [ ] 确认已重启监控服务
- [ ] 查看日志文件是否有错误

### 问题：文件没有备份

**检查清单**：
- [ ] 确认 `enabled` 为 `true`
- [ ] 确认扩展名在白名单中（白名单模式）
- [ ] 确认扩展名不在黑名单中（黑名单模式）
- [ ] 确认文件大小未超过 `max_file_size`
- [ ] 查看日志文件

### 问题：备份了不想要的文件

**解决方案**：
- 使用黑名单模式排除
- 添加 `common_blacklist` 预设
- 使用白名单模式精确控制

---

## 📚 相关文档

- **详细配置**：`自定义过滤器配置说明.md`
- **快速参考**：`快速配置参考.md`
- **配置示例**：`备份配置文件/config_自定义过滤器示例.json`
- **完整文档**：`备份配置文件/README.md`

---

## 🎉 优化总结

### 代码层面
✅ 修复了 `saveConfiguration()` 函数，正确保存 `filter` 配置  
✅ 完善了所有 `strategy` 参数的保存  
✅ 改进了 GUI 界面提示信息  

### 文档层面
✅ 创建了详细的配置说明文档  
✅ 提供了14个实际使用示例  
✅ 添加了快速参考指南  
✅ 完善了常见问题解答  

### 用户体验
✅ GUI 中添加了清晰的使用提示  
✅ 提供了多种配置方式选择  
✅ 文档覆盖了各种使用场景  
✅ 问题排查更加方便  

---

**现在用户可以通过 GUI 或配置文件轻松设置自定义过滤器，配置会正确保存并生效！**
