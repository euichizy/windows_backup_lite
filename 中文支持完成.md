# 中文预设支持 - 完成！✅

## 修改总结

### 1. 添加 UTF-8 ↔ UTF-16 转换函数

在 `src/gui_app.cpp` 中添加了两个辅助函数：

```cpp
// UTF-8 → UTF-16 (用于显示)
std::wstring Utf8ToWide(const std::string& utf8str);

// UTF-16 → UTF-8 (用于保存)
std::string WideToUtf8(const std::wstring& wstr);
```

### 2. 修复所有字符串转换

替换了所有简单的 `std::wstring(str.begin(), str.end())` 为正确的 UTF-8 转换：

**修复的位置**：
- ✅ 预设名称显示（格式窗口）
- ✅ 预设名称显示（源配置对话框）
- ✅ 路径显示（设置对话框）
- ✅ 路径显示（状态对话框）
- ✅ 路径显示（格式窗口）
- ✅ 扩展名显示
- ✅ 错误消息显示
- ✅ 用户输入保存（路径、预设、扩展名）

### 3. 创建中文预设文件

创建了 `presets_中文.json`，包含：

**编程语言类**：
- 代码文件
- C++项目
- Python项目
- Web前端

**文件类型类**：
- 文档
- 图片
- 音频
- 视频
- 压缩包
- 电子书

**排除类**：
- 排除临时文件
- 排除编译产物

### 4. 创建测试工具

- `测试中文预设.bat` - 自动设置测试环境
- `中文预设支持说明.md` - 详细使用说明

## 技术细节

### 为什么需要转换？

Windows GUI 使用 UTF-16 (wchar_t, wstring)
JSON 文件使用 UTF-8 (char, string)

简单的 `begin()` 到 `end()` 转换只适用于 ASCII 字符，对中文会产生乱码。

### 转换原理

```
JSON (UTF-8)  →  MultiByteToWideChar  →  GUI (UTF-16)
     ↓                                        ↓
  "代码文件"                              L"代码文件"
     ↑                                        ↑
JSON (UTF-8)  ←  WideCharToMultiByte  ←  GUI (UTF-16)
```

### 关键代码示例

**显示预设（UTF-8 → UTF-16）**：
```cpp
// 错误方式（会乱码）
std::wstring name(it.key().begin(), it.key().end());

// 正确方式
std::wstring name = Utf8ToWide(it.key());
```

**保存路径（UTF-16 → UTF-8）**：
```cpp
// 错误方式（会乱码）
std::string path(wstr.begin(), wstr.end());

// 正确方式
std::string path = WideToUtf8(wstr);
```

## 测试步骤

### 快速测试

```bash
# 1. 运行测试脚本
测试中文预设.bat

# 2. 编译程序
cmake --build build --config Release

# 3. 运行程序
.\build\Release\main_gui.exe

# 4. 查看中文预设
右键托盘 → "备份格式"
```

### 详细测试

#### 测试 1：预设显示
1. 打开"备份格式"窗口
2. 应该看到：
   - 【代码文件】
   - 【文档】
   - 【图片】
   - 等等...

#### 测试 2：预设添加
1. 打开"备份设置"
2. 点击"添加"
3. 在"可用预设"中双击"代码文件"
4. 应该成功添加

#### 测试 3：中文路径
1. 选择包含中文的路径（如 D:\测试文件夹）
2. 保存配置
3. 打开 config.json
4. 应该看到正确的中文路径

#### 测试 4：配置保存和加载
1. 添加中文预设和中文路径
2. 保存并退出程序
3. 重新运行程序
4. 打开设置，应该正确显示

## 支持的场景

### ✅ 完全支持

1. **中文预设名称**
   - 代码文件
   - 我的项目
   - 工作文档
   - 等等...

2. **中文路径**
   - D:\我的项目
   - C:\用户\张三\文档
   - E:\工作文件

3. **中英混合**
   - 预设：cpp + 代码文件
   - 路径：D:\Projects\我的项目

4. **特殊字符**
   - 中文标点：【】、，。
   - 空格：我的 项目
   - 数字：项目2024

## 配置示例

### 纯中文配置

```json
{
  "backup_destination_base": "D:\\备份",
  "backup_sources": [
    {
      "path": "D:\\我的项目",
      "enabled": true,
      "presets": ["代码文件", "排除临时文件"]
    }
  ]
}
```

### 中英混合配置

```json
{
  "backup_destination_base": "D:\\Backups",
  "backup_sources": [
    {
      "path": "D:\\Projects\\我的项目",
      "enabled": true,
      "presets": ["cpp", "代码文件"]
    }
  ]
}
```

## 注意事项

### 1. 文件编码

**必须使用 UTF-8 编码（无 BOM）**：
- config.json
- presets.json
- presets_中文.json

### 2. 编辑器设置

推荐使用支持 UTF-8 的编辑器：
- Visual Studio Code ✅
- Notepad++ ✅
- Sublime Text ✅
- 记事本（Windows 10+）✅

避免使用：
- 旧版记事本（Windows 7）❌
- 不支持 UTF-8 的编辑器 ❌

### 3. 系统要求

- Windows 7 或更高版本
- 已安装中文字体（通常默认安装）
- 支持 Unicode 的文件系统（NTFS）

## 性能影响

UTF-8 ↔ UTF-16 转换的性能影响：
- **可忽略不计**：转换只在显示和保存时进行
- **不影响监控**：文件监控不涉及字符串转换
- **不影响备份**：备份操作使用原始路径

## 兼容性

### 向后兼容

✅ 完全兼容现有英文配置
✅ 可以逐步迁移到中文预设
✅ 中英文可以混用

### 向前兼容

✅ 未来版本将继续支持中文
✅ 配置文件格式不变

## 故障排除

### 问题：中文显示为乱码

**原因**：JSON 文件编码不是 UTF-8

**解决**：
1. 用 VS Code 打开文件
2. 右下角点击编码
3. 选择"通过编码保存"
4. 选择"UTF-8"

### 问题：预设列表为空

**原因**：presets.json 格式错误或不存在

**解决**：
1. 检查 presets.json 是否存在
2. 使用 JSON 验证器检查格式
3. 使用提供的 presets_中文.json

### 问题：保存后中文变成问号

**原因**：文件系统不支持 Unicode

**解决**：
1. 确保使用 NTFS 文件系统
2. 检查磁盘格式
3. 避免使用 FAT32

## 文件清单

### 新增文件
- ✅ `presets_中文.json` - 中文预设配置
- ✅ `中文预设支持说明.md` - 使用说明
- ✅ `测试中文预设.bat` - 测试脚本
- ✅ `中文支持完成.md` - 本文档

### 修改文件
- ✅ `src/gui_app.cpp` - 添加转换函数，修复所有转换

### 未修改文件
- ⚪ `include/gui_app.h` - 无需修改
- ⚪ 其他源文件 - 无需修改

## 编译

```bash
# 清理并重新编译
cmake --build build --config Release --clean-first
```

## 总结

🎉 **完全支持中文预设！**

- ✅ 正确的 UTF-8 ↔ UTF-16 转换
- ✅ 所有界面正确显示中文
- ✅ 配置正确保存和加载
- ✅ 中英文可以混用
- ✅ 向后兼容
- ✅ 性能无影响

现在你可以自由使用中文预设名称，让配置更加直观易懂！

## 下一步

1. 运行 `测试中文预设.bat`
2. 编译程序
3. 测试中文预设功能
4. 根据需要自定义预设
5. 开始使用！

祝使用愉快！🎊
